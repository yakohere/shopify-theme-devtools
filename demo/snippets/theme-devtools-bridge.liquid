{%- comment -%}
  Theme Devtools Bridge
  Renders devtools context and loads JS/CSS only on development/preview themes.

  Usage: {% render 'theme-devtools-bridge' %}

  Development: Set devtools_local to true and run `npm run dev`
  Production:  Set devtools_local to false and update devtools_cdn_base

  Metafields Schema: Copy content from your theme's metafields.json into devtools_metafields_schema below
{%- endcomment -%}

{%- assign devtools_local = true -%}
{%- assign devtools_localhost = 'http://localhost:9999' -%}
{%- assign devtools_cdn_base = 'https://cdn.example.com/theme-devtools/v1.0.0' -%}

{%- comment -%} 
  Metafields Schema: Paste your theme's metafields.json content here.
  This file is auto-generated by Shopify and located at the root of your theme.
  Having this schema enables the devtools to show ALL defined metafields,
  not just ones with values.
{%- endcomment -%}
{%- capture devtools_metafields_schema -%}
{
  "article": [],
  "blog": [],
  "collection": [],
  "company": [],
  "company_location": [],
  "location": [],
  "market": [],
  "order": [],
  "page": [],
  "product": [],
  "variant": [],
  "shop": [],
  "customer": []
}
{%- endcapture -%}

{%- comment -%} 
  Auto-extract namespaces from schema, or use fallback list if schema is empty
{%- endcomment -%}
{%- assign devtools_extracted_namespaces = '' -%}
{%- assign devtools_schema_parts = devtools_metafields_schema | split: '"namespace": "' -%}
{%- for part in devtools_schema_parts -%}
  {%- unless forloop.first -%}
    {%- assign ns_end = part | split: '"' | first -%}
    {%- if ns_end != blank -%}
      {%- unless devtools_extracted_namespaces contains ns_end -%}
        {%- if devtools_extracted_namespaces == '' -%}
          {%- assign devtools_extracted_namespaces = ns_end -%}
        {%- else -%}
          {%- assign devtools_extracted_namespaces = devtools_extracted_namespaces | append: ',' | append: ns_end -%}
        {%- endif -%}
      {%- endunless -%}
    {%- endif -%}
  {%- endunless -%}
{%- endfor -%}

{%- comment -%} Use extracted namespaces if found, otherwise use fallback {%- endcomment -%}
{%- if devtools_extracted_namespaces != '' -%}
  {%- assign devtools_metafield_namespaces = devtools_extracted_namespaces | split: ',' -%}
{%- else -%}
  {%- assign devtools_metafield_namespaces = 'custom,global,shopify,filters,bundle' | split: ',' -%}
{%- endif -%}

{%- if theme.role == 'development' or theme.role == 'unpublished' -%}
  {%- capture devtools_context -%}
    {
      "meta": {
        "theme": {
          "id": {{ theme.id | json }},
          "name": {{ theme.name | json }},
          "role": {{ theme.role | json }}
        },
        "template": {
          "name": {{ template.name | json }},
          "suffix": {{ template.suffix | json }},
          "directory": {{ template.directory | json }}
        },
        "request": {
          "host": {{ request.host | json }},
          "path": {{ request.path | json }},
          "page_type": {{ request.page_type | json }},
          "design_mode": {{ request.design_mode | json }},
          "visual_preview_mode": {{ request.visual_preview_mode | json }},
          "locale": {
            "iso_code": {{ request.locale.iso_code | json }},
            "name": {{ request.locale.name | json }},
            "primary": {{ request.locale.primary | json }}
          },
          "origin": {{ request.origin | json }}
        },
        "localization": {
          "country": {
            "iso_code": {{ localization.country.iso_code | json }},
            "name": {{ localization.country.name | json }},
            "currency": {
              "iso_code": {{ localization.country.currency.iso_code | json }},
              "symbol": {{ localization.country.currency.symbol | json }}
            }
          },
          "language": {
            "iso_code": {{ localization.language.iso_code | json }},
            "name": {{ localization.language.name | json }}
          },
          "market": {
            "id": {{ localization.market.id | json }},
            "handle": {{ localization.market.handle | json }}
          }
        }
      },
      "objects": {
        "shop": {
          "id": {{ shop.id | json }},
          "name": {{ shop.name | json }},
          "domain": {{ shop.domain | json }},
          "permanent_domain": {{ shop.permanent_domain | json }},
          "url": {{ shop.url | json }},
          "secure_url": {{ shop.secure_url | json }},
          "email": {{ shop.email | json }},
          "description": {{ shop.description | json }},
          "address": {
            "address1": {{ shop.address.address1 | json }},
            "city": {{ shop.address.city | json }},
            "province": {{ shop.address.province | json }},
            "province_code": {{ shop.address.province_code | json }},
            "zip": {{ shop.address.zip | json }},
            "country": {{ shop.address.country | json }},
            "country_code": {{ shop.address.country_code | json }}
          },
          "currency": {{ shop.currency | json }},
          "money_format": {{ shop.money_format | json }},
          "money_with_currency_format": {{ shop.money_with_currency_format | json }},
          "enabled_currencies": {{ shop.enabled_currencies | map: 'iso_code' | json }},
          "enabled_locales": {{ shop.enabled_locales | map: 'iso_code' | json }},
          "metafields_count": {{ shop.metafields | size | json }}
        },
        {%- if customer -%}
        "customer": {
          "id": {{ customer.id | json }},
          "email": "***@{{ customer.email | split: '@' | last }}",
          "first_name": {{ customer.first_name | json }},
          "last_name": {{ customer.last_name | json }},
          "has_account": {{ customer.has_account | json }},
          "accepts_marketing": {{ customer.accepts_marketing | json }},
          "orders_count": {{ customer.orders_count | json }},
          "total_spent": {{ customer.total_spent | json }},
          "tags": {{ customer.tags | json }},
          "default_address": {
            "city": {{ customer.default_address.city | json }},
            "province": {{ customer.default_address.province | json }},
            "country": {{ customer.default_address.country | json }}
          }
        },
        {%- else -%}
        "customer": null,
        {%- endif -%}
        {%- if product -%}
        "product": {
          "id": {{ product.id | json }},
          "title": {{ product.title | json }},
          "handle": {{ product.handle | json }},
          "type": {{ product.type | json }},
          "vendor": {{ product.vendor | json }},
          "available": {{ product.available | json }},
          "published_at": {{ product.published_at | date: "%Y-%m-%dT%H:%M:%S%z" | json }},
          "created_at": {{ product.created_at | date: "%Y-%m-%dT%H:%M:%S%z" | json }},
          "tags": {{ product.tags | json }},
          "price": {{ product.price | json }},
          "price_min": {{ product.price_min | json }},
          "price_max": {{ product.price_max | json }},
          "price_varies": {{ product.price_varies | json }},
          "compare_at_price": {{ product.compare_at_price | json }},
          "compare_at_price_min": {{ product.compare_at_price_min | json }},
          "compare_at_price_max": {{ product.compare_at_price_max | json }},
          "compare_at_price_varies": {{ product.compare_at_price_varies | json }},
          "variants_count": {{ product.variants | size | json }},
          "options_count": {{ product.options | size | json }},
          "options": {{ product.options_with_values | json }},
          "images_count": {{ product.images | size | json }},
          "featured_image": {{ product.featured_image | json }},
          "has_only_default_variant": {{ product.has_only_default_variant | json }},
          "requires_selling_plan": {{ product.requires_selling_plan | json }},
          "selected_variant": {
            "id": {{ product.selected_variant.id | json }},
            "title": {{ product.selected_variant.title | json }},
            "sku": {{ product.selected_variant.sku | json }},
            "price": {{ product.selected_variant.price | json }},
            "available": {{ product.selected_variant.available | json }}
          },
          "selected_or_first_available_variant": {
            "id": {{ product.selected_or_first_available_variant.id | json }},
            "title": {{ product.selected_or_first_available_variant.title | json }},
            "sku": {{ product.selected_or_first_available_variant.sku | json }},
            "price": {{ product.selected_or_first_available_variant.price | json }},
            "available": {{ product.selected_or_first_available_variant.available | json }}
          },
          "url": {{ product.url | json }},
          "metafields_count": {{ product.metafields | size | json }}
        },
        {%- else -%}
        "product": null,
        {%- endif -%}
        {%- if collection -%}
        "collection": {
          "id": {{ collection.id | json }},
          "title": {{ collection.title | json }},
          "handle": {{ collection.handle | json }},
          "description": {{ collection.description | truncate: 200 | json }},
          "products_count": {{ collection.products_count | json }},
          "all_products_count": {{ collection.all_products_count | json }},
          "all_tags": {{ collection.all_tags | json }},
          "all_vendors": {{ collection.all_vendors | json }},
          "sort_by": {{ collection.sort_by | json }},
          "default_sort_by": {{ collection.default_sort_by | json }},
          "url": {{ collection.url | json }},
          "image": {{ collection.image | json }}
        },
        {%- else -%}
        "collection": null,
        {%- endif -%}
        {%- if article -%}
        "article": {
          "id": {{ article.id | json }},
          "title": {{ article.title | json }},
          "handle": {{ article.handle | json }},
          "author": {{ article.author | json }},
          "created_at": {{ article.created_at | date: "%Y-%m-%dT%H:%M:%S%z" | json }},
          "published_at": {{ article.published_at | date: "%Y-%m-%dT%H:%M:%S%z" | json }},
          "tags": {{ article.tags | json }},
          "comments_count": {{ article.comments_count | json }},
          "comments_enabled": {{ article.comments_enabled | json }},
          "url": {{ article.url | json }},
          "excerpt": {{ article.excerpt | truncate: 200 | json }}
        },
        {%- else -%}
        "article": null,
        {%- endif -%}
        {%- if blog -%}
        "blog": {
          "id": {{ blog.id | json }},
          "title": {{ blog.title | json }},
          "handle": {{ blog.handle | json }},
          "articles_count": {{ blog.articles_count | json }},
          "all_tags": {{ blog.all_tags | json }},
          "comments_enabled": {{ blog.comments_enabled | json }},
          "url": {{ blog.url | json }}
        },
        {%- else -%}
        "blog": null,
        {%- endif -%}
        {%- if page -%}
        "page": {
          "id": {{ page.id | json }},
          "title": {{ page.title | json }},
          "handle": {{ page.handle | json }},
          "author": {{ page.author | json }},
          "template_suffix": {{ page.template_suffix | json }},
          "url": {{ page.url | json }}
        },
        {%- else -%}
        "page": null,
        {%- endif -%}
        "cart": {
          "item_count": {{ cart.item_count | json }},
          "total_price": {{ cart.total_price | json }},
          "currency": {{ cart.currency.iso_code | json }},
          "items_count": {{ cart.items | size | json }},
          "_note": "Full cart data fetched via /cart.js"
        }
      },
      "metafields": {
        {%- comment -%} Shop Metafields {%- endcomment -%}
        "shop": {
          {%- assign mf_first = true -%}
          {%- for ns in devtools_metafield_namespaces -%}
            {%- assign shop_ns = shop.metafields[ns] -%}
            {%- if shop_ns != blank -%}
              {%- unless mf_first -%},{%- endunless -%}{%- assign mf_first = false -%}
              "{{ ns }}": {
                {%- for field in shop_ns -%}
                  "{{ field.first }}": {
                    "value": {{ field.last.value | json }},
                    "type": {{ field.last.type | json }}
                  }{%- unless forloop.last -%},{%- endunless -%}
                {%- endfor -%}
              }
            {%- endif -%}
          {%- endfor -%}
        },
        {%- comment -%} Product Metafields {%- endcomment -%}
        {%- if product -%}
        "product": {
          {%- assign mf_first = true -%}
          {%- for ns in devtools_metafield_namespaces -%}
            {%- assign product_ns = product.metafields[ns] -%}
            {%- if product_ns != blank -%}
              {%- unless mf_first -%},{%- endunless -%}{%- assign mf_first = false -%}
              "{{ ns }}": {
                {%- for field in product_ns -%}
                  "{{ field.first }}": {
                    "value": {{ field.last.value | json }},
                    "type": {{ field.last.type | json }}
                  }{%- unless forloop.last -%},{%- endunless -%}
                {%- endfor -%}
              }
            {%- endif -%}
          {%- endfor -%}
        },
        {%- else -%}
        "product": null,
        {%- endif -%}
        {%- comment -%} Collection Metafields {%- endcomment -%}
        {%- if collection -%}
        "collection": {
          {%- assign mf_first = true -%}
          {%- for ns in devtools_metafield_namespaces -%}
            {%- assign collection_ns = collection.metafields[ns] -%}
            {%- if collection_ns != blank -%}
              {%- unless mf_first -%},{%- endunless -%}{%- assign mf_first = false -%}
              "{{ ns }}": {
                {%- for field in collection_ns -%}
                  "{{ field.first }}": {
                    "value": {{ field.last.value | json }},
                    "type": {{ field.last.type | json }}
                  }{%- unless forloop.last -%},{%- endunless -%}
                {%- endfor -%}
              }
            {%- endif -%}
          {%- endfor -%}
        },
        {%- else -%}
        "collection": null,
        {%- endif -%}
        {%- comment -%} Customer Metafields {%- endcomment -%}
        {%- if customer -%}
        "customer": {
          {%- assign mf_first = true -%}
          {%- for ns in devtools_metafield_namespaces -%}
            {%- assign customer_ns = customer.metafields[ns] -%}
            {%- if customer_ns != blank -%}
              {%- unless mf_first -%},{%- endunless -%}{%- assign mf_first = false -%}
              "{{ ns }}": {
                {%- for field in customer_ns -%}
                  "{{ field.first }}": {
                    "value": {{ field.last.value | json }},
                    "type": {{ field.last.type | json }}
                  }{%- unless forloop.last -%},{%- endunless -%}
                {%- endfor -%}
              }
            {%- endif -%}
          {%- endfor -%}
        },
        {%- else -%}
        "customer": null,
        {%- endif -%}
        {%- comment -%} Article Metafields {%- endcomment -%}
        {%- if article -%}
        "article": {
          {%- assign mf_first = true -%}
          {%- for ns in devtools_metafield_namespaces -%}
            {%- assign article_ns = article.metafields[ns] -%}
            {%- if article_ns != blank -%}
              {%- unless mf_first -%},{%- endunless -%}{%- assign mf_first = false -%}
              "{{ ns }}": {
                {%- for field in article_ns -%}
                  "{{ field.first }}": {
                    "value": {{ field.last.value | json }},
                    "type": {{ field.last.type | json }}
                  }{%- unless forloop.last -%},{%- endunless -%}
                {%- endfor -%}
              }
            {%- endif -%}
          {%- endfor -%}
        },
        {%- else -%}
        "article": null,
        {%- endif -%}
        {%- comment -%} Page Metafields {%- endcomment -%}
        {%- if page -%}
        "page": {
          {%- assign mf_first = true -%}
          {%- for ns in devtools_metafield_namespaces -%}
            {%- assign page_ns = page.metafields[ns] -%}
            {%- if page_ns != blank -%}
              {%- unless mf_first -%},{%- endunless -%}{%- assign mf_first = false -%}
              "{{ ns }}": {
                {%- for field in page_ns -%}
                  "{{ field.first }}": {
                    "value": {{ field.last.value | json }},
                    "type": {{ field.last.type | json }}
                  }{%- unless forloop.last -%},{%- endunless -%}
                {%- endfor -%}
              }
            {%- endif -%}
          {%- endfor -%}
        },
        {%- else -%}
        "page": null,
        {%- endif -%}
        {%- comment -%} Blog Metafields {%- endcomment -%}
        {%- if blog -%}
        "blog": {
          {%- assign mf_first = true -%}
          {%- for ns in devtools_metafield_namespaces -%}
            {%- assign blog_ns = blog.metafields[ns] -%}
            {%- if blog_ns != blank -%}
              {%- unless mf_first -%},{%- endunless -%}{%- assign mf_first = false -%}
              "{{ ns }}": {
                {%- for field in blog_ns -%}
                  "{{ field.first }}": {
                    "value": {{ field.last.value | json }},
                    "type": {{ field.last.type | json }}
                  }{%- unless forloop.last -%},{%- endunless -%}
                {%- endfor -%}
              }
            {%- endif -%}
          {%- endfor -%}
        }
        {%- else -%}
        "blog": null
        {%- endif -%}
      },
      "sectionSettings": {
        {%- comment -%} Section settings are injected via JS from data attributes {%- endcomment -%}
      },
      "metafieldsSchema": {{ devtools_metafields_schema }},
      "timestamp": {{ 'now' | date: '%s' | json }}
    }
  {%- endcapture -%}

  <script type="application/json" id="__THEME_DEVTOOLS_CONTEXT__">
    {{ devtools_context }}
  </script>

  <div id="__THEME_DEVTOOLS_ROOT__" style="display:contents;"></div>

  {% comment %} theme-check-disable RemoteAsset {% endcomment %}
  {%- if devtools_local -%}
    <script type="module" src="{{ devtools_localhost }}/src/scripts/main.js"></script>
  {%- else -%}
    <script>
      window.__THEME_DEVTOOLS_CSS_URL__ = '{{ devtools_cdn_base }}/theme-devtools.css';
    </script>
    <script src="{{ devtools_cdn_base }}/theme-devtools.js" defer></script>
  {%- endif -%}
  {% comment %} theme-check-enable RemoteAsset {% endcomment %}
{%- endif -%}
